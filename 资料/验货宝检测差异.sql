/*
ğŸ” éªŒè´§å®æ£€æµ‹å·®å¼‚åˆ†æ
ç”¨é€”ï¼šç»Ÿè®¡éªŒè´§å®è®¾å¤‡å¤–è§‚æ£€æµ‹ä¸­æ˜¾ç¤º"æ— é—®é¢˜"çš„å„é¡¹æŒ‡æ ‡
å°±åƒç»Ÿè®¡"ä½“æ£€ä¸­å“ªäº›é¡¹ç›®æ˜¾ç¤ºæ­£å¸¸çš„è®¾å¤‡æœ‰å¤šå°‘å°"
*/

select 
    month(a.fend_time) as "æœˆä»½",          -- æ£€æµ‹å®Œæˆçš„æœˆä»½
    to_date(a.fend_time) as fdetect_time, -- æ£€æµ‹å®Œæˆçš„å…·ä½“æ—¥æœŸ
    a.fserial_number,                     -- è®¾å¤‡åºåˆ—å·
    count(case when b.fissue_name='å±å¹•å¤–è§‚åˆ’ç—•' and b.fanswer_name="æ— " then a.fserial_number else null end) as 'å±å¹•å¤–è§‚åˆ’ç—•-æ— ',
    -- â†‘ ç»Ÿè®¡å±å¹•å¤–è§‚åˆ’ç—•æ£€æµ‹ç»“æœä¸º"æ— "çš„è®¾å¤‡æ•°é‡
    count(case when b.fissue_name='å¤–å£³åˆ’ç—•' and b.fanswer_name="æ— " then a.fserial_number else null end) as 'å¤–å£³åˆ’ç—•-æ— ',
    -- â†‘ ç»Ÿè®¡å¤–å£³åˆ’ç—•æ£€æµ‹ç»“æœä¸º"æ— "çš„è®¾å¤‡æ•°é‡
    count(case when b.fissue_name='å¤–å£³ç£•ç¢°' and b.fanswer_name="æ— " then a.fserial_number else null end) as 'å¤–å£³ç£•ç¢°-æ— ',
    -- â†‘ ç»Ÿè®¡å¤–å£³ç£•ç¢°æ£€æµ‹ç»“æœä¸º"æ— "çš„è®¾å¤‡æ•°é‡
    count(case when b.fissue_name='å¤–å£³å°æ¸' and b.fanswer_name="æ— " then a.fserial_number else null end) as 'å¤–å£³å°æ¸-æ— '
    -- â†‘ ç»Ÿè®¡å¤–å£³å°æ¸æ£€æµ‹ç»“æœä¸º"æ— "çš„è®¾å¤‡æ•°é‡
    -- è¿™4ä¸ªç»Ÿè®¡å°±åƒä½“æ£€æ—¶ç»Ÿè®¡"è¡€å‹æ­£å¸¸"ã€"å¿ƒè·³æ­£å¸¸"ç­‰é¡¹ç›®çš„äººæ•°
    
from (select 
            *,
            row_number() over(partition by fserial_number order by fend_time desc) as num
            -- â†‘ ä¸ºæ¯ä¸ªè®¾å¤‡çš„æ£€æµ‹è®°å½•ç¼–å·ï¼ŒæŒ‰ç»“æŸæ—¶é—´å€’åºï¼Œç¡®ä¿å–æœ€æ–°çš„ä¸€æ¬¡æ£€æµ‹
            
        from drt.drt_my33310_detection_t_detect_record  -- ä»"æ£€æµ‹è®°å½•è¡¨"
        where fdet_type=0                 -- æ£€æµ‹ç±»å‹ä¸º0ï¼ˆç‰¹å®šçš„æ£€æµ‹ç±»å‹ï¼‰
        and fis_deleted=0                 -- è®°å½•æœªè¢«åˆ é™¤
    	and fverdict<>"æµ‹è¯•å•"            -- ä¸æ˜¯æµ‹è¯•å•
        and to_date(fend_time) >='2023-09-01'  -- 2023å¹´9æœˆ1æ—¥ä»¥åçš„è®°å½•
        and left(fserial_number,2) in ('01','02')  -- åªçœ‹éªŒè´§å®è®¾å¤‡ï¼ˆ01ã€02å¼€å¤´ï¼‰
        ) as a
left join dwd.dwd_detect_back_detection_issue_and_answer_v2 as b on a.frecord_id=b.fdetect_record_id
-- â†‘ å…³è”æ£€æµ‹é—®é¢˜ç­”æ¡ˆè¡¨ï¼Œè·å–å…·ä½“çš„æ£€æµ‹é¡¹ç›®å’Œç»“æœ
-- å°±åƒæŠŠä½“æ£€æŠ¥å‘Šå’Œå…·ä½“çš„æ£€æŸ¥é¡¹ç›®ç»“æœè¿æ¥èµ·æ¥

where left(a.fserial_number,2) in ('01','02')  -- å†æ¬¡ç¡®è®¤åªçœ‹éªŒè´§å®è®¾å¤‡
and a.num=1                           -- åªè¦æ¯ä¸ªè®¾å¤‡æœ€æ–°çš„ä¸€æ¬¡æ£€æµ‹
and b.field_source='fdet_norm_snapshot'  -- åªè¦æ ‡å‡†æ£€æµ‹å¿«ç…§æ•°æ®
and b.ds>='2023-09-01'                -- æ£€æµ‹æ•°æ®ä¹Ÿè¦åœ¨æŒ‡å®šæ—¥æœŸèŒƒå›´å†…
and b.fissue_name in ('å¤–å£³åˆ’ç—•','å¤–å£³ç£•ç¢°','å±å¹•å¤–è§‚åˆ’ç—•','å¤–å£³å°æ¸')  -- åªå…³æ³¨è¿™4ä¸ªæ£€æµ‹é¡¹ç›®
and b.fanswer_name='æ— '               -- åªç»Ÿè®¡ç»“æœä¸º"æ— "ï¼ˆå³æ— é—®é¢˜ï¼‰çš„æƒ…å†µ
group by 1,2,3                       -- æŒ‰æœˆä»½ã€æ—¥æœŸã€åºåˆ—å·åˆ†ç»„ç»Ÿè®¡

/*
ğŸ’¡ ç®€å•è§£é‡Šï¼š
è¿™ä¸ªæŸ¥è¯¢å°±åƒåŒ»é™¢ç»Ÿè®¡ä½“æ£€æŠ¥å‘Šï¼š
"ç»™æˆ‘ç»Ÿè®¡ä¸€ä¸‹2023å¹´9æœˆä»¥åï¼ŒéªŒè´§å®è®¾å¤‡æ£€æµ‹ä¸­
å„é¡¹å¤–è§‚æ£€æŸ¥æ˜¾ç¤º'æ— é—®é¢˜'çš„è®¾å¤‡åˆ†åˆ«æœ‰å¤šå°‘å°ï¼ŒæŒ‰æœˆä»½å’Œæ—¥æœŸåˆ†ç»„"

ğŸ” å…³é”®è¯è§£é‡Šï¼š
- fdet_type=0 = ç‰¹å®šçš„æ£€æµ‹ç±»å‹
- fis_deleted=0 = è®°å½•æœªè¢«åˆ é™¤ï¼ˆæœ‰æ•ˆè®°å½•ï¼‰
- fverdict<>"æµ‹è¯•å•" = ä¸æ˜¯æµ‹è¯•æ•°æ®
- case when...then...else null end = æ¡ä»¶ç»Ÿè®¡ï¼ˆæ»¡è¶³æ¡ä»¶å°±ç»Ÿè®¡ï¼Œå¦åˆ™ä¸è®¡å…¥ï¼‰

ğŸ“Š ç»“æœç¤ºä¾‹ï¼š
æœˆä»½ | æ£€æµ‹æ—¥æœŸ   | åºåˆ—å·  | å±å¹•åˆ’ç—•-æ—  | å¤–å£³åˆ’ç—•-æ—  | å¤–å£³ç£•ç¢°-æ—  | å¤–å£³å°æ¸-æ— 
1    | 2024-01-01 | ABC123  | 1          | 1          | 1          | 1
1    | 2024-01-02 | DEF456  | 1          | 0          | 1          | 1

æ¯è¡Œä»£è¡¨ä¸€ä¸ªè®¾å¤‡åœ¨æŸä¸ªæ—¥æœŸçš„å„é¡¹å¤–è§‚æ£€æµ‹"æ— é—®é¢˜"çš„ç»Ÿè®¡ç»“æœ
*/
