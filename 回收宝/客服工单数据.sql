select 
    a.fid as "工单ID",
      CASE 
    WHEN COUNT(1) OVER (PARTITION BY  a.forder_id ) > 1 
    THEN 1 
    ELSE 0  
    END AS is_repeat,
    COUNT( a.forder_id) OVER (PARTITION BY  a.forder_id) AS repeat_count,
    case 
        when d.fcontent!='重新匹配' and d.fcontent!='滞留设备' and d.fcontent!='取消滞留' and d.fcontent!='订单待跟进（客诉专用）' and d.fcontent!='找机重检' and ((a.fwork_type=1 and a.fappeal_type2 not in (
100,
100000,
100001,
100002,
101002,
104001,
104002,
104003,
105001,
105002,
105003,
105004,
106001,
106002,
106003,
106004,
108001,
108002,
109011,
109013,
109028,
109029,
109030,
109031,
109032,
109033,
109034,
109036,
109037,
109038,
109039,
109042,
109043,
109052,
109053,
109063,
109065,
109080,
109081,
109082,
109083,
109084,
109085,
109086,
109088,
109089,
109090,
109091,
109094,
109095,
109104,
109105,
109115,
109125,
109136,
109137,
109138,
109140,
109143,
109144,
109151,
109152,
109153,
109154,
109160,
109176,
109177,
109178,
109180,
109181,
109182,
109183,
109185,
109186,
109187,
109188,
109196,
109197,
109198,
109199,
109203,
109224,
109226,
109243,
109251,
109252,
109255,
109256,
109257,
109260,
109261,
109263,
109268,
109293,
109294,
109296,
109297,
109299,
109300,
109302,
109303,
109313,
109327,
109329,
109335,
109337,
109343,
109363,
109365,
109371,
109384,
109386,
109392,
109394,
109400,
109420,
109422,
109428,
109459,
109462,
109465,
109477,
109479,
109494,
109498,
109502,
109506,
109515,
109517,
109547,
109550,
109553,
109554,
109564,
109571,
109577,
109581)) or (a.fwork_type=2 and a.fappeal_type2 in(
101001,
101003,
101004,
101005,
101006,
101007,
102001,
102002,
102003,
102004,
103001,
103002,
105005,
106006,
109001,
109012,
109014,
109015,
109016,
109017,
109018,
109020,
109021,
109022,
109023,
109024,
109025,
109035,
109041,
109044,
109064,
109066,
109067,
109068,
109069,
109070,
109072,
109073,
109074,
109075,
109076,
109077,
109087,
109093,
109096,
109123,
109124,
109127,
109128,
109131,
109133,
109141,
109145,
109159,
109161,
109163,
109166,
109167,
109168,
109169,
109172,
109202,
109204,
109205,
109207,
109213,
109218,
109219,
109220,
109225,
109231,
109262,
109264,
109265,
109266,
109267,
109278,
109291,
109309,
109310,
109432,
109434,
109435,
109451,
109452,
109590,
109591,
109592,
109593,
109594,
109595,
109596,
109597))) then "问询"
        when (a.fwork_type=2 and a.fappeal_type2 not in(
101001,
101003,
101004,
101005,
101006,
101007,
102001,
102002,
102003,
102004,
103001,
103002,
105005,
106006,
109001,
109012,
109014,
109015,
109016,
109017,
109018,
109020,
109021,
109022,
109023,
109024,
109025,
109035,
109041,
109044,
109064,
109066,
109067,
109068,
109069,
109070,
109072,
109073,
109074,
109075,
109076,
109077,
109087,
109093,
109096,
109123,
109124,
109127,
109128,
109131,
109133,
109141,
109145,
109159,
109161,
109163,
109166,
109167,
109168,
109169,
109172,
109202,
109204,
109205,
109207,
109213,
109218,
109219,
109220,
109225,
109231,
109262,
109264,
109265,
109266,
109267,
109278,
109291,
109309,
109310,
109432,
109434,
109435,
109451,
109452,
109590,
109591,
109592,
109593,
109594,
109595,
109596,
109597)) or (a.fwork_type=1
and a.fappeal_type2 in (
100,
100000,
100001,
100002,
101002,
104001,
104002,
104003,
105001,
105002,
105003,
105004,
106001,
106002,
106003,
106004,
108001,
108002,
109011,
109013,
109028,
109029,
109030,
109031,
109032,
109033,
109034,
109036,
109037,
109038,
109039,
109042,
109043,
109052,
109053,
109063,
109065,
109080,
109081,
109082,
109083,
109084,
109085,
109086,
109088,
109089,
109090,
109091,
109094,
109095,
109104,
109105,
109115,
109125,
109136,
109137,
109138,
109140,
109143,
109144,
109151,
109152,
109153,
109154,
109160,
109176,
109177,
109178,
109180,
109181,
109182,
109183,
109185,
109186,
109187,
109188,
109196,
109197,
109198,
109199,
109203,
109224,
109226,
109243,
109251,
109252,
109255,
109256,
109257,
109260,
109261,
109263,
109268,
109293,
109294,
109296,
109297,
109299,
109300,
109302,
109303,
109313,
109327,
109329,
109335,
109337,
109343,
109363,
109365,
109371,
109384,
109386,
109392,
109394,
109400,
109420,
109422,
109428,
109459,
109462,
109465,
109477,
109479,
109494,
109498,
109502,
109506,
109515,
109517,
109547,
109550,
109553,
109554,
109564,
109571,
109577,
109581)) then "客诉"
		when a.fwork_type=1 then "问询"
        when a.fwork_type=3 and a.fappeal_type2!=109210 then "异常包裹"
        when a.fwork_type=3 and a.fappeal_type2=109210 then "异常包裹-杭州"
        when a.fwork_type=4 then "问密"
    else null end as "工单类型",
    a.fwork_source,
    case when a.fwork_status=40 then 1 else 0 end as "是否已完成",
    from_unixtime(a.Fupdate_time) as "结束工单时间",
    from_unixtime(a.Fadd_time) as "创建工单时间",
    a.fappeal_content as "诉求内容",
    d.fcontent as  "诉求类型",
    a.forder_id as "订单ID",
    a.fuser_phone as "用户电话",
    case when right(left(a.Fbarcode_sn,6),4)="0112" then "东莞" 
         when left(a.Fbarcode_sn,3)="020" then "杭州"
    else "深圳" end as "所在地",
    case when right(left(a.Fbarcode_sn,6),4)="0112" then 12 
         when left(a.Fbarcode_sn,3)="020" then 2
    else 1 end as fwarehouse_code,
    case when left(g.fseries_number,2)='BM' or b.fchannel_name like "%寄卖%" then "寄卖"
         when g.fseries_number is not null and left(g.fseries_number,2)!='BM' and  b.fchannel_name not like "%寄卖%" then "回收" 
         when (g.fseries_number is null and c.fhost_barcode is not null) or a.Forder_system=1 or (b.fchannel_name is null and a.fwork_type=3) then "验机" else "回收" end as "业务类型",
    if(a.Fbarcode_sn is not null,a.Fbarcode_sn,b.fseries_number) as fseires_number,
    b.fproject_name,
    b.fchannel_name,
    if(b.fproduct_name is not null,b.fproduct_name,c.fhsb_product_name) as fproduct_name,
    b.fclass_name,
    a.fduty_content as "责任内容",
    a.forder_sn as "订单编号",
    if((unix_timestamp(from_unixtime(a.Fupdate_time),'yyyy-MM-dd HH:mm:ss')-unix_timestamp(from_unixtime(a.Fadd_time),'yyyy-MM-dd HH:mm:ss'))>0 and a.fwork_status=40,(unix_timestamp(from_unixtime(a.Fupdate_time),'yyyy-MM-dd HH:mm:ss')-unix_timestamp(from_unixtime(a.Fadd_time),'yyyy-MM-dd HH:mm:ss'))/3600,null) as "工单耗时/小时",
    case when d.fcontent="问密（杭州仓专用）" and a.fupdate_user in ("黄丽萍","杨香英","钟小慧",'郑静敏') then null else a.fupdate_user end as "操作人",
    if(a.fadd_user like "%jiangjianfang%","江剑芳",if(a.fadd_user like "%@%",h.freal_name,a.fadd_user)) as fadd_user,
    if(if((unix_timestamp(from_unixtime(a.Fupdate_time),'yyyy-MM-dd HH:mm:ss')-unix_timestamp(from_unixtime(a.Fadd_time),'yyyy-MM-dd HH:mm:ss'))>0 and a.fwork_status=40,(unix_timestamp(from_unixtime(a.Fupdate_time),'yyyy-MM-dd HH:mm:ss')-unix_timestamp(from_unixtime(a.Fadd_time),'yyyy-MM-dd HH:mm:ss'))/3600,null)<=24,1,0) as "24小时内解决",
    if(if((unix_timestamp(from_unixtime(a.Fupdate_time),'yyyy-MM-dd HH:mm:ss')-unix_timestamp(from_unixtime(a.Fadd_time),'yyyy-MM-dd HH:mm:ss'))>0 and a.fwork_status=40,(unix_timestamp(from_unixtime(a.Fupdate_time),'yyyy-MM-dd HH:mm:ss')-unix_timestamp(from_unixtime(a.Fadd_time),'yyyy-MM-dd HH:mm:ss'))/3600,null)<=48,1,0) as "48小时内解决",
    if(if((unix_timestamp(from_unixtime(a.Fupdate_time),'yyyy-MM-dd HH:mm:ss')-unix_timestamp(from_unixtime(a.Fadd_time),'yyyy-MM-dd HH:mm:ss'))>0 and a.fwork_status=40,(unix_timestamp(from_unixtime(a.Fupdate_time),'yyyy-MM-dd HH:mm:ss')-unix_timestamp(from_unixtime(a.Fadd_time),'yyyy-MM-dd HH:mm:ss'))/3600,null)<=72,1,0) as "72小时内解决",    
    from_unixtime(e.fadd_time) as "挂起时间",
    case when Fwork_status=5 then "待分配"
    	 when Fwork_status=10 then "已申请"
         when Fwork_status=20 then "处理中"
         when Fwork_status=40 then "已完成"
    else null end as fwork_status,
    b.forder_status_name,
    case when g.frecycle_type=1 then "邮寄"
  		 when g.frecycle_type=2 then "上门"
  	     when g.frecycle_type=3 then "到店"
  	else null end as "履约方式",
    f.ffeedback_str
from drt.drt_my33310_csrdb_t_works as a
left join dws.dws_hs_order_detail as b on a.forder_id=b.forder_id
left join drt.drt_my33310_recycle_t_order as g on a.forder_id=g.forder_id
left join dws.dws_xy_yhb_detail as c on a.forder_id=c.forder_id
left join drt.drt_my33310_csrdb_t_works_config_appeal as d on a.fappeal_type2=d.fid
left join drt.drt_my33310_csrdb_t_works_hang_up as e on a.fid=e.fwork_id
left join drt.drt_my33310_csrdb_t_work_device_pwd_consulting as f on a.fid=f.fwork_id
left join drt.drt_my33310_amcdb_t_user as h on a.fadd_user=h.fusername
where from_unixtime(a.Fadd_time) >=to_date(date_sub(from_unixtime(unix_timestamp()),720))
and a.fwork_type in(1,2,3,4)
--and a.fwork_source<>3
and a.fappeal_type1<>0
and a.fduty_content not like "%无效工单%"
--and a.fwork_status=40
--and to_date(from_unixtime(a.fadd_time)) between "2022-04-25" and "2022-05-24"
--and a.fupdate_user in ("周文静","张丽明","林宁")
and a.fid not in (5216304,5202228,5201932,5194484,5201594)
union all
select 
		a.Fanomaly_recourse_id as "工单ID",
 CASE 
    WHEN COUNT(1) OVER (PARTITION BY  a.Fxy_order_id ) > 1 
    THEN 1 
  ELSE 0 
  END AS is_repeat,
  COUNT(a.Fxy_order_id) OVER (PARTITION BY a.Fxy_order_id) AS repeat_count,
		"天猫问询" as "工单类型",
		null as fwork_source,
		case when a.Fstatus=2 then 1 else 0 end as "是否已完成",
		case when a.Fworkcard_last_rsp_time <>"0000-00-00 00:00:00" then a.Fworkcard_last_rsp_time else null end as "结束工单时间",
		a.Fsubmit_time as "创建工单时间",
		a.Fservice_code as "诉求内容",
		a.Fquestion_type  as "诉求类型",
		a.Fxy_order_id as "订单ID",
		d.fsender_phone as "用户电话",
        case when right(left(c.fseries_number,6),4)="0112" then "东莞" 
		     when left(e.fhost_barcode,3)="020" then "杭州"
		else "深圳" end as "所在地",
		case when right(left(c.fseries_number,6),4)="0112" then 12 
		     when left(e.fhost_barcode,3)="020" then 2
		else 1 end as fwarehouse_code,
		"回收" as "业务类型",
        if(e.fhost_barcode is not null,e.fhost_barcode,c.fseries_number) as fseires_number,
		d.fproject_name,
        d.fchannel_name,
        d.fproduct_name,
        d.fclass_name,
		null as "责任内容",
		null as "订单编号",
		if((unix_timestamp(a.Fworkcard_last_rsp_time,'yyyy-MM-dd HH:mm:ss')-unix_timestamp(a.Fsubmit_time,'yyyy-MM-dd HH:mm:ss'))>0 and a.Fstatus=2,(unix_timestamp(a.Fworkcard_last_rsp_time,'yyyy-MM-dd HH:mm:ss')-unix_timestamp(a.Fsubmit_time,'yyyy-MM-dd HH:mm:ss'))/3600,null) as "工单耗时/小时",
        b.freal_name as "操作人",
        b.freal_name as fadd_user,
        if(if((unix_timestamp(a.Fworkcard_last_rsp_time,'yyyy-MM-dd HH:mm:ss')-unix_timestamp(a.Fsubmit_time,'yyyy-MM-dd HH:mm:ss'))>0 and a.Fstatus=2,(unix_timestamp(a.Fworkcard_last_rsp_time,'yyyy-MM-dd HH:mm:ss')-unix_timestamp(a.Fsubmit_time,'yyyy-MM-dd HH:mm:ss'))/3600,null)<=24,1,0) as "24小时内解决",
        if(if((unix_timestamp(a.Fworkcard_last_rsp_time,'yyyy-MM-dd HH:mm:ss')-unix_timestamp(a.Fsubmit_time,'yyyy-MM-dd HH:mm:ss'))>0 and a.Fstatus=2,(unix_timestamp(a.Fworkcard_last_rsp_time,'yyyy-MM-dd HH:mm:ss')-unix_timestamp(a.Fsubmit_time,'yyyy-MM-dd HH:mm:ss'))/3600,null)<=48,1,0) as "48小时内解决",
        if(if((unix_timestamp(a.Fworkcard_last_rsp_time,'yyyy-MM-dd HH:mm:ss')-unix_timestamp(a.Fsubmit_time,'yyyy-MM-dd HH:mm:ss'))>0 and a.Fstatus=2,(unix_timestamp(a.Fworkcard_last_rsp_time,'yyyy-MM-dd HH:mm:ss')-unix_timestamp(a.Fsubmit_time,'yyyy-MM-dd HH:mm:ss'))/3600,null)<=72,1,0) as "72小时内解决",
        null as "挂起时间",
        case when a.fstatus=0 then "未响应"
             when a.fstatus=1 then "求助中"
             when a.fstatus=2 then "已完结"
        else null end as fwork_status,
        d.forder_status_name,
        case when d.frecycle_type=1 then "邮寄"
  		 when d.frecycle_type=2 then "上门"
  	     when d.frecycle_type=3 then "到店"
  		else null end as "履约方式",
        null as ffeedback_str
from drt.drt_my33310_recycle_t_tmall_fuwu_anomaly_basic_info as a
left join drt.drt_my33310_amcdb_t_user as b on a.Fworkcard_last_operator=b.Fusername
left join dws.dws_hs_order_detail_al as c on a.Fxy_order_id=c.Fxy_order_id
left join dws.dws_hs_order_detail as d on c.forder_id=d.forder_id
left join dws.dws_xy_yhb_detail as e on a.fxy_order_id=e.fxy_order_id
where a.Fvalid=1
and Fbuyer_nick not like "%测试%"


